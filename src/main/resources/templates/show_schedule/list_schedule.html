<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Minton - Responsive Admin Dashboard Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="A fully featured admin theme which can be used to build CRM, CMS, etc." name="description">
    <meta content="Coderthemes" name="author">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <th:block th:replace="/layout/head :: head"/>
    <script src="/assets/js/app/jquery-3.6.0.min.js"></script>
</head>
<body>
<div id = "wrapper">
    <th:block th:replace="/layout/navbar :: navbar"/>
    <th:block th:replace="/layout/left_sidebar :: left_side"/>

    <!-- ============================================================== -->
    <!-- Start Page Content here -->
    <!-- ============================================================== -->

    <div class="content-page">
        <div class="content">

            <!-- Start Content-->
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box">
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Minton</a></li>
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Apps</a></li>
                                    <li class="breadcrumb-item active">Tickets</li>
                                </ol>
                            </div>
                            <h4 class="page-title">Tickets</h4>
                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <div class="row">
                    <div class="col-12">
                        <div class="card-box">

                            <div class="text-center mb-2">
                                <div class="row">
                                    <div class="col-md-6 col-xl-3">
                                        <div class="card-box">
                                            <i class="fe-tag font-24"></i>
                                            <h3>25563</h3>
                                            <p class="text-uppercase mb-1 font-13 font-weight-medium">Total tickets</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-xl-3">
                                        <div class="card-box">
                                            <i class="fe-archive font-24"></i>
                                            <h3 class="text-warning">6952</h3>
                                            <p class="text-uppercase mb-1 font-13 font-weight-medium">Pending Tickets</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-xl-3">
                                        <div class="card-box">
                                            <i class="fe-shield font-24"></i>
                                            <h3 class="text-success">18361</h3>
                                            <p class="text-uppercase mb-1 font-13 font-weight-medium">Closed Tickets</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-xl-3">
                                        <div class="card-box">
                                            <i class="fe-delete font-24"></i>
                                            <h3 class="text-danger">250</h3>
                                            <p class="text-uppercase mb-1 font-13 font-weight-medium">Deleted Tickets</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-5">
                                    <h4 style="font-size: 30px">
                                        <i class="icon-copy fa fa-glass" aria-hidden="true"></i>
                                        <strong> List Show Schedule</strong>
                                    </h4>
                                </div>
                            </div>

                            <div class="row mt-3">

                                <div class="col-sm-8 ">
                                    <div id="DataTables_Table_0_filter" class="dataTables_filter">
                                        <a style="box-shadow: 0 0 1px 1px #4a4b59;" class="btn btn-light create-modal float-end">
                                            <i class="icon-copy fa fa-plus-square" aria-hidden="true"></i>
                                            <span><strong> Add New Show Schedule</strong></span>
                                        </a>
                                    </div>
                                </div>

                                <div class="col-sm-4 header-search">
                                    <form>
                                        <div class="form-group mb-0">
                                            <i id="search-icon" class="icon-copy fa fa-search" aria-hidden="true"></i>
                                            <input id="search-input" type="text" class="form-control search-input" placeholder="Search Here">
                                        </div>
                                    </form>
                                </div>
                            </div>


                            <table class="table table-hover m-0 table-centered dt-responsive nowrap w-100" cellspacing="0" id="tickets-table">
                                <thead class="bg-light">
                                <tr>
                                    <th class="font-weight-medium">ID</th>
                                    <th class="font-weight-medium">Movie</th>
                                    <th class="font-weight-medium">Room</th>
                                    <th class="font-weight-medium">Branch</th>
                                    <th class="font-weight-medium">Show Time SLot </th>
                                    <th class="font-weight-medium">Show Date</th>
                                    <th class="font-weight-medium">Create By</th>
                                    <th class="font-weight-medium" style="width: 120px">Action</th>
                                </tr>
                                </thead>

                                <tbody class="font-14">

                                </tbody>
                            </table>
                        </div>
                    </div><!-- end col -->
                </div>
                <!-- end row -->

            </div> <!-- container -->

        </div> <!-- content -->

        <!-- Footer Start -->
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-6">
                        2016 - 2019 &copy; Minton theme by <a href="">Coderthemes</a>
                    </div>
                    <div class="col-md-6">
                        <div class="text-md-right footer-links d-none d-sm-block">
                            <a href="javascript:void(0);">About Us</a>
                            <a href="javascript:void(0);">Help</a>
                            <a href="javascript:void(0);">Contact Us</a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- end Footer -->

    </div>

    <!-- ============================================================== -->
    <!-- End Page content -->
    <!-- ============================================================== -->
</div>

    <th:block th:replace="/show_schedule/modal_create_show_schedule :: modal_create_show_schedule"/>
    <th:block th:replace="/show_schedule/modal_update_show_schedule :: modal_update_show_schedule"/>
    <th:block th:replace="/show_schedule/temp_show_schedule :: temp_list_show_schedule"/>

    <script src="/assets/js/app/custom-validation-schedule.js"></script>
    <th:block th:replace="/layout/script :: script-app"/>
    <th:block th:replace="/layout/script :: script-page"/>

    <script src="/assets/js/app/jquery.validate.js"></script>
</body>
<script>

    let page = {
        url: {
            getAllSchedule: App.BASE_URL + "/show-schedules",
            getScheduleById: App.BASE_URL + "/show-schedules/",
            createShowSchedule: App.BASE_URL + "/show-schedules/create",
            updateShowSchedule: App.BASE_URL + "/show-schedules/update/",
            deleteShowSchedule: App.BASE_URL + "/show-schedules/delete/",
            searchShowSchedule: App.BASE_URL + "/show-schedules/search",
            getAllBranch: App.BASE_URL + "/branches",
            getAllRoomByBranchId: App.BASE_URL + "/rooms/",
            getAllMovie: App.BASE_URL + "/movies"
        },
        element: {},
        loadData: {},
        commands: {},
        dialogs: {
            element: {},
            commands :{}
        }
    }

    page.element.tbBody = $("#tickets-table tbody");
    page.element.searchIcon = $('#search-icon');
    page.element.searchInput = $("#search-input");
    page.element.tempShowSchedule = $("#tempShowSchedule");


    page.dialogs.element.handleCre = $(".create-modal");

    page.dialogs.element.mdCreate = $("#modalCreateShowSchedule");
    page.dialogs.element.mdUpdate = $("#modalUpdateShowSchedule");

    page.dialogs.element.btnCreate = $("#btnCreateShowSchedule")
    page.dialogs.element.btnUpdate = $("#btnUpdateShowSchedule");
    page.dialogs.element.btnClose = $(".btn-close");


    page.dialogs.element.frmCreate = $("#frmCreateShowSchedule");
    page.dialogs.element.frmUpdate = $("#frmUpdateShowSchedule");

    page.dialogs.element.movieId = $("#movie");
    page.dialogs.element.branchId = $("#branch");
    page.dialogs.element.roomId = $("#room");
    page.dialogs.element.showDate = $("#showDate");
    page.dialogs.element.showTimeSlot = $("#showTimeSlot");

    page.dialogs.element.movieIdUp = $("#movieUp");
    page.dialogs.element.branchIdUp = $("#branchUp");
    page.dialogs.element.roomIdUp = $("#roomUp");
    page.dialogs.element.showDateUp = $("#showDateUp");
    page.dialogs.element.showTimeSlotUp = $("#showTimeSlotUp");

    page.dialogs.element.mdAlertDangerCre = $("#modalCreateShowSchedule .modal-alert-danger");
    page.dialogs.element.mdAlertDangerUp = $("#modalUpdateShowSchedule .modal-alert-danger");

    page.dialogs.element.inputErrorCre = $("#frmCreateShowSchedule input.error");
    page.dialogs.element.inputErrorUp = $("#frmUpdateShowSchedule input.error");



    let showSchedule = new ShowSchedule();


    let tempShowSchedule = $.validator.format($.trim(page.element.tempShowSchedule.val().toString()));

    page.commands.findById = (id) => {
        return $.ajax({
            type: "GET",
            url: page.url.getScheduleById + id
        })
            .done((data) => {
                showSchedule = data;
            })
            .fail((err) => {
                alert("Id not found");
            })
    }

    page.commands.addRow = () => {
            page.element.tbBody.prepend($(tempShowSchedule(showSchedule.id, showSchedule.movieName, showSchedule.roomName, showSchedule.branchName, showSchedule.showDate, showSchedule.showTimeSlot)));
    }

    page.commands.updateRow = () => {
        let currentRow = $("#tr_" + showSchedule.id);
        let rowUpdated = $(tempShowSchedule(showSchedule.id, showSchedule.movieName, showSchedule.roomName, showSchedule.branchName, showSchedule.showDate, showSchedule.showTimeSlot))

        currentRow.replaceWith(rowUpdated);
    }

    page.commands.deleteRow = (id) => {
        let currentRow = $("#tr_" + id);
        currentRow.replaceWith("");
    }

    page.dialogs.element.handleCre.on("click", function () {
        page.dialogs.element.mdCreate.modal("show");
    })



    page.commands.handleUpdateBtn = () => {

        $(".update").on('click', function () {
            let id = $(this).data('id');
            page.commands.findById(id).then(function () {
                page.dialogs.element.movieIdUp.val(showSchedule.movieId);
                page.dialogs.element.showDateUp.val(showSchedule.showDate);
                page.dialogs.element.showTimeSlotUp.val(showSchedule.showTimeSlot);

                page.dialogs.element.branchIdUp.val(showSchedule.branchId);

                page.commands.getRoom(showSchedule.branchId).then( () => {
                    page.dialogs.element.roomIdUp.val(showSchedule.roomId);
                })

                page.dialogs.element.mdUpdate.modal('show');
            });
        });
    }

    page.commands.handleDeleteBtn = () =>  {
        $(".delete").on("click", function () {
            let id = $(this).data("id");

            page.commands.findById(id).then(function () {
                console.log(showSchedule);
                App.SweetAlert.showSuspendConfirmDialog()
                    .then((result) => {

                        if (result.isConfirmed)
                            doDelete();
                    });
            }).catch(() => {
                alert("handleBlock fail!");
            })
        })
    }


    page.commands.handleBtn = () => {
        page.commands.handleUpdateBtn();
        page.commands.handleDeleteBtn();
    }

    page.dialogs.element.btnCreate.on("click", function () {
        page.dialogs.element.mdAlertDangerCre.removeClass('show').addClass('hide').empty();
        page.dialogs.element.frmCreate.submit();
    })

    page.dialogs.element.btnUpdate.on('click', function () {
        page.dialogs.element.mdAlertDangerUp.removeClass('show').addClass('hide').empty();
        page.dialogs.element.frmUpdate.submit();
    })

    page.commands.getMovie = () => {

        return $.ajax({
            type: "GET",
            url: page.url.getAllMovie,
        }).done((data) => {
            page.dialogs.element.movieId.empty();
            page.dialogs.element.movieIdUp.empty();

            $.each(data, (i, item) => {
                let  str = `<option value="${item.id}">${item.title}</option>`;
                page.dialogs.element.movieId.append(str);
                page.dialogs.element.movieIdUp.append(str);

            })
        })
            .fail((err) => {
                alert("Load movie fail!");
            })
    }

    page.commands.getBranch = () => {

        return $.ajax({
            type: "GET",
            url: page.url.getAllBranch
        }).done((data) => {
            page.dialogs.element.branchId.empty();
            page.dialogs.element.branchIdUp.empty();


            $.each(data, (i, item) => {
                  let  str = `<option value="${item.id}">${item.name}</option>`;
                page.dialogs.element.branchId.append(str);
                page.dialogs.element.branchIdUp.append(str);

            })
        })
            .fail((err) => {
                alert("Load branch fail!");
            })
    }

    page.commands.getRoom = (branchId) => {

        return $.ajax({
            type: "GET",
            url: page.url.getAllRoomByBranchId + branchId,
        }).done((data) => {
            page.dialogs.element.roomId.empty();
            page.dialogs.element.roomIdUp.empty();


            $.each(data, (i, item) => {
                let  str = `<option value="${item.id}">${item.name}</option>`;
                page.dialogs.element.roomId.append(str);
                page.dialogs.element.roomIdUp.append(str);
            })
        })
            .fail((err) => {
                alert("Load room fail!");
            })
    }

    page.dialogs.element.branchId.on("input", function () {
        let branchId = page.dialogs.element.branchId.val();
        page.commands.getRoom(branchId);
    })

    page.dialogs.element.branchIdUp.on("input", function () {
        let branchId = page.dialogs.element.branchIdUp.val();
        page.commands.getRoom(branchId);
    })

    page.commands.loadShowScheduleInfo = () => {
        page.commands.getMovie().then(() => {
            page.commands.getBranch().then(() => {
                let branchId = page.dialogs.element.branchId.val();
                page.commands.getRoom(branchId);
            })
        })
    }


    page.loadData.loadShowSchedule = () => {
        $.ajax({
            type: "GET",
            url: page.url.getAllSchedule
        })
            .done((item) => {
                $.each(item, (i, item) => {
                    showSchedule = item;
                    page.commands.addRow();

                    page.commands.handleBtn();


                })
                page.commands.loadShowScheduleInfo();

            })
            .fail((jqXHR) => {
                let str = ``;

                if (jqXHR.status === 401) {
                    setTimeout(() => {
                        App.SweetAlert.showErrorAlert(App.ERROR_401);
                    }, 3000)

                    location.href = "/logout";

                } else if (jqXHR.status === 403) {
                    location.href = "/errors/403";

                } else if (jqXHR.status === 500) {
                    location.href = "/errors/500";
                } else if (jqXHR.responseJSON) {

                    $.each(jqXHR.responseJSON, function (key, value) {
                        str += `<label id="${key}Read-error" class="error" for="${key}Read">${value}</label>`;
                        $("#" + key).addClass("error");
                    });
                    l
                }
            })
    }



    page.commands.doCreate = () => {

        delete showSchedule.id;
        showSchedule.movieId = page.dialogs.element.movieId.val();
        showSchedule.movieName = $("#movie option:selected").text();
        showSchedule.branchId = page.dialogs.element.branchId.val();
        showSchedule.branchName = $("#branch option:selected").text();
        showSchedule.roomId = page.dialogs.element.roomId.val();
        showSchedule.roomName = $("#room option:selected").text();
        showSchedule.showDate = page.dialogs.element.showDate.val();
        showSchedule.showTimeSlot = page.dialogs.element.showTimeSlot.val();


        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "POST",
            url: page.url.createShowSchedule,
            data: JSON.stringify(showSchedule)
        })
            .done((item) => {
                showSchedule = item;

                page.commands.addRow();

                // page.commands.handleBtn();

                page.dialogs.element.mdCreate.modal("hide");

                App.SweetAlert.showSuccessAlert(App.CREATE_SHOW_SCHEDULE_SUCCESS);
            })
            .fail((jqXHR) => {

                let str = ``;

                if (jqXHR.status === 401) {
                    setTimeout(() => {
                        App.SweetAlert.showErrorAlert(App.ERROR_401);
                    },3000)

                    location.href = "/logout";

                } else if(jqXHR.status === 403) {
                    App.SweetAlert.showErrorAlert(App.ERROR_403);

                }  else if(jqXHR.status === 500) {
                    App.SweetAlert.showErrorAlert(App.ERROR_500);
                } else if(jqXHR.responseJSON) {

                    $.each(jqXHR.responseJSON, function (key, value) {
                        str += `<label id="${key}-error" class="error" for="${key}">${value}</label>`;
                        $("#" + key).addClass("error");
                    });

                }

                page.dialogs.element.mdAlertDangerCre.empty().removeClass("hide").addClass("show").append(str);
            });
        page.dialogs.element.frmCreate[0].reset();
    }

    page.commands.doUpdate = () => {

        showSchedule.movieId = page.dialogs.element.movieIdUp.val();
        showSchedule.movieName = $("#movieUp option:selected").text();
        showSchedule.branchId = page.dialogs.element.branchIdUp.val();
        showSchedule.branchName = $("#branchUp option:selected").text();
        showSchedule.roomId = page.dialogs.element.roomIdUp.val();
        showSchedule.roomName = $("#roomUp option:selected").text();
        showSchedule.showDate = page.dialogs.element.showDateUp.val()
        showSchedule.showTimeSlot = page.dialogs.element.showTimeSlotUp.val();


        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "PUT",
            url: page.url.updateShowSchedule + showSchedule.id,
            data: JSON.stringify(showSchedule)
        })
            .done((item) => {
                showSchedule = item;

                page.commands.updateRow();
                page.commands.handleBtn();
                page.dialogs.element.mdUpdate.modal("hide");

                App.SweetAlert.showSuccessAlert(App.UPDATE_SHOW_SCHEDULE_SUCCESS);

            })
            .fail((jqXHR) => {

                let str = ``;

                if (jqXHR.status === 401) {
                    App.SweetAlert.showErrorAlert(App.ERROR_401);
                    setTimeout(() => {
                        location.href = "/logout";
                    }, 3000)

                } else if (jqXHR.status === 403) {
                    App.SweetAlert.showErrorAlert(App.ERROR_403);

                } else if (jqXHR.status === 500) {
                    App.SweetAlert.showErrorAlert(App.ERROR_500);
                } else if (jqXHR.responseJSON) {

                    $.each(jqXHR.responseJSON, function (key, value) {
                        str += `<label id="${key}Up-error" class="error" for="${key}Up">${value}</label>`;
                        $("#" + key).addClass("error");
                    });
                    page.dialogs.element.mdAlertDangerUp.empty().removeClass("hide").addClass("show").append(str);
                }
            })
    }

    function doDelete() {
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "PUT",
            url: page.url.deleteShowSchedule  + showSchedule.id,
            data: JSON.stringify(showSchedule)
        })
            .done((item) => {

                page.commands.deleteRow(item);
                page.commands.handleBtn();

               App.SweetAlert.showSuccessAlert(App.DELETE_SHOW_SCHEDULE_SUCCESS);
            })
            .fail((jqXHR) => {

                if (jqXHR.status === 401) {
                    App.SweetAlert.showErrorAlert(App.ERROR_401);
                    setTimeout(() => {
                        location.href = "/logout";
                    },3000)

                } else if(jqXHR.status === 403) {
                    App.SweetAlert.showErrorAlert(App.ERROR_403);

                }  else if(jqXHR.status === 500) {
                    App.SweetAlert.showErrorAlert(App.ERROR_500);
                }
            })
    }



    page.dialogs.element.mdCreate.on("hidden.bs.modal", function () {
        page.dialogs.element.mdAlertDangerCre.empty().removeClass('show').addClass('hide');
        page.dialogs.element.frmCreate[0].reset();
    });

    page.dialogs.element.mdUpdate.on("hidden.bs.modal", function () {
        page.dialogs.element.mdAlertDangerUp.empty().removeClass('show').addClass('hide');
        page.dialogs.element.frmUpdate[0].reset();
    });


    page.commands.getToDay = (day) => {
        let today = new Date();
        let dd = String(today.getDate() + day).padStart(2, '0');
        let mm = String(today.getMonth() + 1).padStart(2, '0');
        let yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;

        return today;
    }

    page.dialogs.element.showDate.attr("min", page.commands.getToDay(0));

    page.dialogs.element.showDate.attr("max", function () {
        let today = new Date();
        let dd = String(today.getDate()).padStart(2, '0');
        let mm = String(today.getMonth() + 1).padStart(2, '0');
        let yyyy = Number(today.getFullYear() + 1);
        today = yyyy + '-' + mm + '-' + dd;

        return today;
    });

    page.dialogs.element.showDateUp.attr("min", page.commands.getToDay(0));

    page.dialogs.element.showDateUp.attr("max", function () {
        let today = new Date();
        let dd = String(today.getDate()).padStart(2, '0');
        let mm = String(today.getMonth() + 1).padStart(2, '0');
        let yyyy = Number(today.getFullYear() + 1);
        today = yyyy + '-' + mm + '-' + dd;

        return today;
    });

    page.dialogs.element.btnClose.on('click', () => {
        page.dialogs.element.mdCreate.modal('hide');
        page.dialogs.element.mdUpdate.modal('hide');
    });

    page.element.searchIcon.on('click', () => {
        let searchInput = page.element.searchInput.val();

        $.ajax({
            "headers": {
                "accept": "application/json",
                "content-type": "application/json"
            },
            "type": "POST",
            "url": page.url.searchShowSchedule,
            "data": JSON.stringify(searchInput)
        })
            .done((item) => {
                page.element.tbBody.html("");

                $.each(item, (i, data) => {
                    showSchedule = data;
                    page.commands.addRow();
                })
                page.commands.handleBtn();
            })
    })

    page.element.searchInput.on('input', () => {
        let searchInput = page.element.searchInput.val();

        $.ajax({
            "headers": {
                "accept": "application/json",
                "content-type": "application/json"
            },
            "type": "POST",
            "url": page.url.searchShowSchedule,
            "data": JSON.stringify(searchInput)
        })
            .done((item) => {
                page.element.tbBody.html("");

                $.each(item, (i, data) => {
                    showSchedule = data;
                    page.commands.addRow();
                })
                page.commands.handleBtn();

            })
    })

    page.loadData.loadShowSchedule();






</script>
</html>